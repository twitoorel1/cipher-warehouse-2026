# הרשאות מערכת — גדוד (RBAC)

מסמך זה מגדיר הרשאות לפי מבנה גדודי:

- קצין ראשי
- קצין סגן
- 2 נגדים (אותן הרשאות לשניהם)
- 3 חיילים (אותן הרשאות לשלושתם)

## הגדרות וישויות במערכת (מונחים)

להלן היכולות המרכזיות במערכת:

1. **צפייה**: צפייה בנתונים, חיפוש, פילטרים.
2. **ניהול מכשירים/ציוד**: יצירה, עריכה, שינוי סטטוס, שיוך ליחידה/משתמש.
3. **מלאי וספירות**: עדכון כמויות/ממצאים, פתיחת/סגירת ספירה.
4. **ייבוא/ייצוא**: העלאה מאקסל, ייצוא לאקסל/דוחות.
5. **הערות ותיעוד**: הוספת הערות, צפייה בהיסטוריה.
6. **אישורים**: אישור פעולות “רגישות”.
7. **משתמשים והקצאות**: יצירת משתמשים/שיוך לגדוד, שינוי תפקידים (בתוך הגדוד).
8. **הגדרות גדודיות**: קטגוריות, שדות עזר, תצורות מקומיות.
9. **Audit Log**: צפייה בלוג פעילות (מי שינה מה ומתי), ייצוא לוג.
10. **מחיקה**: מחיקה אמיתית אינה מומלצת; עדיף Soft Delete (deleted_at). הרשאות למחיקה מוגבלות מאוד.

---

## תפקידים (Roles) מומלצים בקוד

מומלץ לייצג תפקידים כך:

- `BATTALION_CHIEF_OFFICER` — קצין ראשי
- `BATTALION_DEPUTY_OFFICER` — קצין סגן
- `BATTALION_NCO` — נגד
- `BATTALION_SOLDIER` — חייל

הערה: מספר האנשים (2 נגדים/3 חיילים) לא משנה הרשאות; זה אותו Role.

---

## מטריצת הרשאות (סיכום מהיר)

| יכולת / פעולה                               | קצין ראשי | קצין סגן | נגד |                   חייל |
| ------------------------------------------- | --------: | -------: | --: | ---------------------: |
| צפייה מלאה בנתוני הגדוד                     |        ✅ |       ✅ |  ✅ |                     ✅ |
| צפייה בין-גדודית (מחוץ לגדוד)               |        ❌ |       ❌ |  ❌ |                     ❌ |
| יצירת מכשיר/פריט חדש                        |        ✅ |       ✅ |  ✅ |                     ❌ |
| עריכת פרטי מכשיר (שם/מק"ט/סידורי/תיאור)     |        ✅ |       ✅ |  ✅ |                     ❌ |
| שינוי סטטוס Lifecycle (פעיל/מושבת וכו’)     |        ✅ |       ✅ |  ✅ |                     ❌ |
| עדכון תוקף סוללה (battery_life)             |        ✅ |       ✅ |  ✅ |                     ❌ |
| שיוך מכשיר לגורם בתוך הגדוד                 |        ✅ |       ✅ |  ✅ |         ✅ (בקשה בלבד) |
| פתיחת ספירת מלאי (Session)                  |        ✅ |       ✅ |  ✅ |                     ❌ |
| עדכון ספירה (רישום ממצאים)                  |        ✅ |       ✅ |  ✅ |                     ✅ |
| סגירת ספירה ונעילה                          |        ✅ |       ✅ |  ✅ |                     ❌ |
| ייבוא מאקסל (Import)                        |        ✅ |       ✅ |  ✅ |                     ❌ |
| ייצוא לאקסל / דוחות                         |        ✅ |       ✅ |  ✅ | ✅ (תצוגה/ייצוא בסיסי) |
| הוספת הערות לציוד                           |        ✅ |       ✅ |  ✅ |                     ✅ |
| צפייה בהיסטוריית שינויים (Audit בסיסי)      |        ✅ |       ✅ |  ✅ |             ✅ (מוגבל) |
| צפייה מלאה ב-Audit Log + ייצוא לוג          |        ✅ |       ✅ |  ✅ |                     ❌ |
| אישור פעולות רגישות (ראו סעיף)              |        ✅ |       ✅ |  ❌ |                     ❌ |
| ניהול משתמשים בתוך הגדוד (יצירה/השבתה/שיוך) |        ✅ |       ✅ |  ❌ |                     ❌ |
| שינוי תפקידים (Roles) בתוך הגדוד            |        ✅ |       ❌ |  ❌ |                     ❌ |
| שינוי הגדרות גדודיות (קטגוריות/תצורה)       |        ✅ |       ✅ |  ❌ |                     ❌ |
| מחיקה (Soft Delete) של פריטים               |        ✅ |       ✅ |  ❌ |                     ❌ |
| שחזור מפריטים שנמחקו (Restore)              |        ✅ |       ✅ |  ❌ |                     ❌ |

---

## פירוט “פעולות רגישות” (שדורשות אישור)

פעולות שנחשבות רגישות ומומלץ לחייב עבורן אישור של קצין ראשי/סגן:

1. **מחיקה (Soft Delete)** של פריט/מכשיר/מסמך.
2. **סגירת ספירת מלאי** (סגירה = נעילה).
3. **ייבוא מאקסל** שמשנה נתונים בכמות גדולה.
4. **שינוי תפקידים** למשתמשים.
5. **שינויים רוחביים בהגדרות גדודיות**.

המלצה פרקטית:

- נגד יכול להכין פעולה (Draft) / להגיש בקשה.
- קצין סגן או ראשי מאשרים ומבצעים בפועל.

---

## כללים חשובים לאכיפה (כדי שזה יעבוד לאורך זמן)

1. **Scope לפי גדוד**: כל API שמחזיר/מעדכן נתונים חייב לסנן לפי `battalion_id` של המשתמש.
2. **No Hard Delete**: רק `deleted_at` + לוג פעילות.
3. **Audit לכל שינוי**: מי שינה, מה שינה, מתי, מאיזה מסך/פעולה.
4. **Role ≠ Unit**: Role קובע “מה מותר”, ו-Unit/גדוד קובע “על מה מותר”.
5. **חיילים לא משנים Master Data**: חייל מעדכן ספירה/ממצאים והערות, לא מגדיר פריטים.

---

## דוגמה: מה כל אחד עושה ביום יום

### קצין ראשי

- מאשר פעולות רגישות.
- מנהל משתמשים ותפקידים.
- מקבל תמונת מצב מלאה, דוחות, חריגים, פגות תוקף.

### קצין סגן

- משמש מאשר חלופי.
- מנהל תפעול שוטף, דוחות, סגירות ספירה.
- יכול למחוק/לשחזר Soft Delete לפי צורך.

### נגד

- תפעול לוגיסטי מלא: פתיחת ספירה, עדכון ציוד, סטטוסים, תוקפי סוללה.
- מייצא דוחות, מייבא אקסל (אם מאושר אצלך במדיניות).
- אינו מנהל משתמשים ואינו משנה תפקידים.

### חייל

- עובד “בשטח”: רושם ממצאים בספירה, מוסיף הערות, מדווח חוסרים/תקלות.
- יכול להוציא ייצוא בסיסי/דוח אישי (אם צריך).
- לא יוצר/עורך Master Data של ציוד.

---
